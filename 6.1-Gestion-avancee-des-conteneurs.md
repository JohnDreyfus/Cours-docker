# 6. Gestion avancée des conteneurs

## Les volumes : persistence des données

### Problématique

- Les conteneurs sont éphémères par nature
- Les données écrites dans un conteneur sont perdues à sa suppression
- Nécessité de persister les données au-delà du cycle de vie du conteneur

### Types de volumes

**1. Volumes nommés (recommandé)**

```bash
docker volume create mon-volume
docker run -v mon-volume:/data nginx
```

- Gérés par Docker
- Stockés dans `/var/lib/docker/volumes/`
- Indépendants du conteneur
- Faciles à sauvegarder et migrer

**2. Bind mounts**

```bash
docker run -v /chemin/hote:/chemin/conteneur nginx
```

- Montage direct d'un répertoire hôte
- Utile pour le développement
- Attention aux permissions et portabilité

**3. Volumes anonymes**

```bash
docker run -v /data nginx
```

- Créés automatiquement
- Difficiles à gérer
- Usage limité

### Commandes de gestion des volumes

```bash
# Lister les volumes
docker volume ls

# Inspecter un volume
docker volume inspect mon-volume

# Supprimer un volume
docker volume rm mon-volume

# Nettoyer les volumes non utilisés
docker volume prune
```

### Exemple pratique : PostgreSQL

```bash
# Créer un volume pour PostgreSQL
docker volume create postgres-data

# Lancer PostgreSQL avec le volume
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=secret \
  -v postgres-data:/var/lib/postgresql/data \
  postgres:15

# Les données survivent à la suppression du conteneur
docker rm -f postgres
docker run -d --name postgres -v postgres-data:/var/lib/postgresql/data postgres:15
```

## Les ports : exposition et mapping

### Concepts

- Les conteneurs possèdent leur propre réseau isolé
- Nécessité d'exposer les ports pour accéder aux services
- Mapping : association port hôte ↔ port conteneur

### Syntaxe de base

```bash
# Format : -p [ip_hote:]port_hote:port_conteneur[/protocole]
docker run -p 8080:80 nginx

# Exemples
-p 80:80              # Port 80 hôte → port 80 conteneur
-p 8080:80            # Port 8080 hôte → port 80 conteneur
-p 127.0.0.1:8080:80  # Écoute uniquement sur localhost
-p 3000-3005:3000-3005 # Plage de ports
```

### Publication de tous les ports exposés

```bash
# -P (majuscule) : assigne automatiquement des ports aléatoires
docker run -P nginx

# Vérifier les ports assignés
docker port nom-conteneur
```

### Exemple : application web

```bash
# Backend Node.js sur port 3000
docker run -d -p 3000:3000 --name backend mon-api:latest

# Frontend React sur port 80
docker run -d -p 8080:80 --name frontend mon-frontend:latest

# Base de données (non exposée publiquement)
docker run -d -p 127.0.0.1:5432:5432 --name db postgres:15
```

## Les variables d'environnement

### Définition

- Permettent de configurer les conteneurs sans reconstruire les images
- Suivent le principe des applications 12-factor
- Essentielles pour gérer différents environnements (dev, staging, prod)

### Passage de variables

```bash
# Option -e ou --env
docker run -e MA_VARIABLE=valeur nginx
docker run -e NODE_ENV=production -e PORT=3000 mon-app

# Depuis un fichier
docker run --env-file ./config.env mon-app
```

### Fichier .env

```bash
# config.env
NODE_ENV=production
DATABASE_HOST=postgres
DATABASE_PORT=5432
DATABASE_NAME=myapp
API_KEY=abc123
```

```bash
docker run --env-file config.env mon-app
```

### Exemple : application Node.js

```bash
docker run -d \
  --name api \
  -e NODE_ENV=production \
  -e DATABASE_URL=postgresql://user:pass@db:5432/mydb \
  -e JWT_SECRET=my-secret-key \
  -e PORT=3000 \
  -p 3000:3000 \
  mon-api:latest
```

### Inspection des variables

```bash
# Voir les variables d'un conteneur
docker inspect -f '{{.Config.Env}}' nom-conteneur

# Ou avec exec
docker exec nom-conteneur env
```

## Les réseaux Docker (introduction)

### Types de réseaux par défaut

**1. Bridge (par défaut)**

- Réseau privé interne
- Communication entre conteneurs via IP
- Isolation par rapport à l'hôte

**2. Host**

- Partage le réseau de l'hôte
- Pas d'isolation réseau
- Performances maximales

**3. None**

- Aucune interface réseau
- Isolation complète

### Commandes de base

```bash
# Lister les réseaux
docker network ls

# Inspecter un réseau
docker network inspect bridge

# Créer un réseau personnalisé
docker network create mon-reseau

# Connecter un conteneur à un réseau
docker network connect mon-reseau mon-conteneur

# Supprimer un réseau
docker network rm mon-reseau
```

### Communication entre conteneurs

```bash
# Créer un réseau personnalisé
docker network create app-network

# Lancer des conteneurs sur ce réseau
docker run -d --name db --network app-network postgres:15
docker run -d --name api --network app-network mon-api:latest

# Dans l'API, on peut maintenant utiliser "db" comme hostname
# Exemple de connexion : postgresql://user:pass@db:5432/mydb
```

### Avantages des réseaux personnalisés

- Résolution DNS automatique par nom de conteneur
- Meilleure isolation
- Communication sécurisée entre conteneurs
- Pas besoin d'exposer les ports en dehors du réseau