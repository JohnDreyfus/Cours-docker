# Docker Compose - Fondamentaux

## Pourquoi Docker Compose ?

### Le problème sans Compose

Avec Docker seul, pour une application multi-conteneurs :

- Lancement manuel de chaque conteneur avec `docker run`
- Gestion complexe des réseaux entre conteneurs
- Configuration répétitive et sujette aux erreurs
- Difficulté à reproduire l'environnement exact

### La solution Docker Compose

- Définition de toute l'infrastructure dans un fichier YAML
- Lancement de l'ensemble des services avec une seule commande
- Gestion automatique des réseaux et dépendances
- Reproductibilité garantie de l'environnement

## Installation et vérification

### Installation

Docker Compose V2 est intégré à Docker Desktop et aux versions récentes de Docker Engine.

Vérification :

```bash
docker compose version
```

Note : La syntaxe moderne utilise `docker compose` (avec espace) et non `docker-compose` (avec tiret).

## Structure du fichier docker-compose.yml

### Exemple minimal

```yaml
services:
  web:
    image: nginx:alpine
    ports:
      - "8080:80"
```

### Hiérarchie principale

```yaml
#version: '3.8'           # Dépprécié

services:                # Définition des conteneurs
  service1:
    # Configuration du service 1
  service2:
    # Configuration du service 2

networks:                # Réseaux personnalisés (optionnel)
  mon-reseau:
    # Configuration réseau

volumes:                 # Volumes nommés (optionnel)
  mes-donnees:
    # Configuration volume
```

## Syntaxe YAML

### Services

Chaque service représente un conteneur :

```yaml
services:
  app:
    image: node:18-alpine        # Image à utiliser
    container_name: mon-app      # Nom du conteneur (optionnel)
    ports:
      - "3000:3000"              # Mapping de ports
    environment:
      - NODE_ENV=production      # Variables d'environnement
    volumes:
      - ./app:/usr/src/app       # Montage de volumes
```

### Networks

Définition de réseaux personnalisés :

```yaml
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

services:
  web:
    networks:
      - frontend
  api:
    networks:
      - frontend
      - backend
  db:
    networks:
      - backend
```

Par défaut, Compose crée un réseau bridge pour tous les services.

### Volumes

Deux types de volumes :

**Volumes nommés** (gérés par Docker) : `/var/lib/docker/volumes/`

```yaml
volumes:
  db-data:

services:
  database:
    volumes:
      - db-data:/var/lib/mysql
```

**Bind mounts** (chemins locaux) :

```yaml
services:
  app:
    volumes:
      - ./src:/app/src           # Chemin relatif
      - /var/log/app:/logs       # Chemin absolu
```

## Commandes de base

### Démarrage

```bash
# Démarrer tous les services
docker compose up

# En arrière-plan (detached mode)
docker compose up -d

# Reconstruire les images avant de démarrer
docker compose up --build

# Démarrer un service spécifique
docker compose up nom-service
```

### Arrêt

```bash
# Arrêter les services (conserve les conteneurs)
docker compose stop

# Arrêter et supprimer les conteneurs
docker compose down

# Supprimer également les volumes
docker compose down -v

# Supprimer également les images
docker compose down --rmi all
```

### Inspection

```bash
# Lister les conteneurs actifs
docker compose ps

# Voir les logs de tous les services
docker compose logs

# Logs d'un service spécifique
docker compose logs nom-service

# Suivre les logs en temps réel
docker compose logs -f

# Logs avec timestamps
docker compose logs -t
```

### Exécution de commandes

```bash
# Exécuter une commande dans un service
docker compose exec nom-service commande

# Exemple : bash dans le service web
docker compose exec web bash

# Exemple : vérifier la version de Node
docker compose exec app node --version
```

### Autres commandes utiles

```bash
# Redémarrer les services
docker compose restart

# Mettre en pause
docker compose pause
docker compose unpause

# Voir les processus en cours
docker compose top

# Valider la syntaxe du fichier
docker compose config
```