# Docker Compose - Avancé

## Configuration des services

### Build

Le paramètre `build` permet de construire une image au lieu d'en utiliser une existante.

**Syntaxe simple :**

```yaml
services:
  app:
    build: ./app
```

**Syntaxe avancée :**

```yaml
services:
  app:
    build:
      context: ./app
      dockerfile: Dockerfile.prod
      args:
        - NODE_ENV=production
        - API_VERSION=2.0
```

**Éléments clés :**

- `context` : répertoire contenant le Dockerfile
- `dockerfile` : nom du Dockerfile à utiliser (par défaut : Dockerfile)
- `args` : arguments de build passés au Dockerfile

### Ports

**Syntaxe courte :**

```yaml
services:
  web:
    ports:
      - "8080:80"      # host:conteneur
      - "443:443"
```

**Syntaxe longue :**

```yaml
services:
  web:
    ports:
      - target: 80
        published: 8080
        protocol: tcp
        mode: host
```

### Environment

**Trois méthodes pour définir les variables d'environnement :**

```yaml
services:
  app:
    # Méthode 1 : directement dans le fichier
    environment:
      - NODE_ENV=production
      - DB_HOST=database
      - API_KEY=secret123
    
    # Méthode 2 : depuis un fichier
    env_file:
      - .env
      - .env.prod
```

### Volumes

**Types de volumes :**

```yaml
services:
  app:
    volumes:
      # Volume nommé
      - db_data:/var/lib/mysql
      
      # Bind mount (chemin absolu ou relatif)
      - ./app:/usr/src/app
      - /host/logs:/var/log
      
      # Volume anonyme
      - /usr/src/app/node_modules
      
      # Read-only
      - ./config:/etc/config:ro

volumes:
  db_data:
```

**Options avancées :**

```yaml
volumes:
  - type: bind
    source: ./app
    target: /usr/src/app
    read_only: false
```

## Dépendances entre services

### depends_on

Définit l'ordre de démarrage des services.

```yaml
services:
  web:
    image: nginx
    depends_on:
      - app
      - database
  
  app:
    build: ./app
    depends_on:
      - database
  
  database:
    image: postgres
```

**Limitations :**

- Ne garantit pas que le service est prêt, seulement qu'il est démarré
- Compose attend que le conteneur soit lancé, pas que l'application soit opérationnelle

### Health checks

Permet de vérifier qu'un service est réellement prêt.

```yaml
services:
  database:
    image: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  
  app:
    build: ./app
    depends_on:
      database:
        condition: service_healthy
```

**Conditions disponibles :**

- `service_started` : par défaut
- `service_healthy` : attend que le healthcheck réussisse
- `service_completed_successfully` : attend que le conteneur se termine avec succès

## Variables d'environnement et fichiers .env

### Fichier .env

Créer un fichier `.env` à la racine du projet :

```bash
# .env
DB_PASSWORD=secret123
API_PORT=3000
NODE_ENV=production
POSTGRES_VERSION=15
```

### Utilisation dans docker-compose.yml

**Substitution de variables :**

```yaml
services:
  database:
    image: postgres:${POSTGRES_VERSION}
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
  
  app:
    build: ./app
    ports:
      - "${API_PORT}:3000"
    environment:
      NODE_ENV: ${NODE_ENV}
```

**Valeurs par défaut :**

```yaml
services:
  app:
    image: node:${NODE_VERSION:-18}
    ports:
      - "${PORT:-3000}:3000"
```

### Ordre de priorité

1. Variables d'environnement du shell
2. Fichier `.env`
3. Valeurs par défaut dans docker-compose.yml

## Scaling de services

Lancer plusieurs instances d'un service.

**Commande :**

```bash
docker-compose up --scale app=3
```

**Configuration :**

```yaml
services:
  app:
    build: ./app
    # Ne pas spécifier de port fixe pour le scaling
    expose:
      - "3000"
  
  load-balancer:
    image: nginx
    ports:
      - "80:80"
    depends_on:
      - app
```

**Exemple avec replicas (Compose v3+) :**

```yaml
services:
  app:
    image: myapp
    deploy:
      replicas: 3
```
### Fichiers multiples

**Utiliser plusieurs fichiers de configuration :**

```bash
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
```

**docker-compose.prod.yml :**

```yaml
services:
  app:
    environment:
      - NODE_ENV=production
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
```